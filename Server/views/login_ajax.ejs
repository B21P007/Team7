<%#
    Team7 client ejs - login ajax | Update: 2021/06/01

    CDN List
    crypto-js : https://cdnjs.com/libraries/crypto-js
%>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"
    integrity="sha512-nOQuvD9nKirvxDdvQ9OMqe2dgapbPB7vYAMrzJihw5m+aNcf0dX53m6YxM4LgA9u8e9eg9QX+/+mPu8kCNpV2A=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script type='text/javascript'>
    const bank = <%-JSON.stringify(crypto_bank)%>;
    var CRYP = {
        // Encrypto
        encryptoo : function(data, bank) {
            srcs = CryptoJS.enc.Utf8.parse(data);
            // console.log(srcs);
            var encrypted = CryptoJS.AES.encrypt(srcs, bank.key, {
                iv: bank.iv,
                mode: CryptoJS.mode.CBC,
                padding: CryptoJS.pad.Pkcs7
            });
            // return encrypted.ciphertext.toString().toUpperCase();
            return encrypted;
        },
        encryptoo2 : function(data, bank) {
            srcs = CryptoJS.enc.Utf8.parse(data);
            return CryptoJS.AES.encrypt(srcs, bank.key);
        },
    }

    function update_iv() {
        var req = new XMLHttpRequest();
        req.onreadystatechange = function () {
            if (req.readyState == 4) {
                if (req.status == 200) {
                    bank.iv = req.responseText;
                    return true;
                }
            }
        }
        req.open('GET', 'login/u', false); // 同期
        req.send();
    }

    function ajax() {
        var req = new XMLHttpRequest();
        var user = document.getElementById('login_fie_input_user').value;
        var pass = document.getElementById('login_fie_input_pass').value;
        if (user.length <= 0 || pass.length <= 0) return;
        req.onreadystatechange = function () {
            if (req.readyState == 4) {
                if (req.status == 200) {
                    console.log(req.responseText);
                }
            }
        }
        update_iv();
        req.open('POST', '', true); // 非同期
        req.setRequestHeader('content-type', 'application/x-www-form-urlencoded;charset=UTF-8');
        // var t_tx = '{"p":"'+encodeURI(pass)+'","u":"'+encodeURI(user)+'"}';
        // var t_tx = 'This is the password (test)'; // b = UTF-32LE : 1644167168
        // var s_tx = 'team7=' + encodeURIComponent(CRYP.encryptoo(t_tx, bank)); // Fixing problems caused by '+'
        // var s_tx = '{"password":"'+encodeURIComponent(CRYP.encryptoo(pass, bank))+'","username":"'+encodeURIComponent(CRYP.encryptoo(user, bank)))+'"}';
        var s_tx = 'password='+encodeURIComponent(CRYP.encryptoo(pass, bank))+'&username='+encodeURIComponent(CRYP.encryptoo(user, bank));
        // var s_tx = 'team7=' + CRYP.encryptoo2(t_tx, bank);
        // console.log(CRYP.decryptoo2(CRYP.encryptoo2(t_tx, bank), bank));
        console.log(s_tx);
        req.send(s_tx);
    }
</script>
